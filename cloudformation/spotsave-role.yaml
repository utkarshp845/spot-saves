AWSTemplateFormatVersion: '2010-09-09'
Description: 'SpotSave Read-Only IAM Role - Allows SpotSave to scan your AWS account for cost savings opportunities'

Parameters:
  SpotSaveAccountId:
    Type: String
    Description: Your SpotSave service account ID (provided by SpotSave)
    NoEcho: false
  
  ExternalId:
    Type: String
    Description: Unique external ID for security (auto-generated)
    Default: ''
  
  RoleName:
    Type: String
    Description: Name for the IAM role
    Default: 'SpotSaveRole'

Resources:
  # SSM Parameter is created by the Lambda function, no need for separate resource

  # Lambda execution role for the custom resource handler
  RoleHandlerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: IAMRoleManagement
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'iam:GetRole'
                  - 'iam:CreateRole'
                  - 'iam:UpdateAssumeRolePolicy'
                  - 'iam:AttachRolePolicy'
                  - 'iam:ListAttachedRolePolicies'
                  - 'iam:GetRolePolicy'
                  - 'iam:PutRolePolicy'
                  - 'iam:TagRole'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'ssm:PutParameter'
                  - 'ssm:GetParameter'
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/spotsave/*'

  # Lambda function to handle role creation/updates (handles existing roles gracefully)
  RoleHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-RoleHandler'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt RoleHandlerExecutionRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import json
          import uuid
          import urllib.request
          from botocore.exceptions import ClientError

          SUCCESS = "SUCCESS"
          FAILED = "FAILED"

          def send(event, context, status, data):
              try:
                  body = {
                      'Status': status,
                      'Reason': f'See CloudWatch: {context.log_stream_name}',
                      'PhysicalResourceId': event.get('PhysicalResourceId', context.log_stream_name),
                      'StackId': event['StackId'],
                      'RequestId': event['RequestId'],
                      'LogicalResourceId': event['LogicalResourceId'],
                      'NoEcho': False,
                      'Data': data
                  }
                  json_body = json.dumps(body)
                  print(f"Sending response: Status={status}, Data keys={list(data.keys()) if data else 'empty'}")
                  req = urllib.request.Request(
                      event['ResponseURL'],
                      data=json_body.encode('utf-8'),
                      method='PUT',
                      headers={'Content-Type': 'application/json', 'Content-Length': str(len(json_body))}
                  )
                  response = urllib.request.urlopen(req, timeout=10)
                  print(f"Response sent successfully: {response.getcode()}")
              except Exception as e:
                  print(f"Failed to send response: {e}")
                  import traceback
                  print(traceback.format_exc())
                  raise

          def lambda_handler(event, context):
              try:
                  print(f"Event: {json.dumps(event)}")
                  
                  props = event['ResourceProperties']
                  role_name = props['RoleName']
                  account_id = props.get('SpotSaveAccountId', '').strip()
                  
                  # Validate required parameters
                  if not account_id:
                      error_msg = "SpotSaveAccountId is required but was not provided. Please provide your SpotSave account ID."
                      print(f"ERROR: {error_msg}")
                      send(event, context, FAILED, {'Error': error_msg})
                      return
                  
                  if not account_id.isdigit() or len(account_id) != 12:
                      error_msg = f"Invalid SpotSaveAccountId: '{account_id}'. Must be a 12-digit AWS account ID."
                      print(f"ERROR: {error_msg}")
                      send(event, context, FAILED, {'Error': error_msg})
                      return
                  
                  iam = boto3.client('iam')
                  ssm = boto3.client('ssm')
                  
                  # Check if role exists
                  try:
                      role = iam.get_role(RoleName=role_name)
                      role_arn = role['Role']['Arn']
                      role_exists = True
                      print(f"Role exists: {role_arn}")
                  except ClientError as e:
                      if e.response['Error']['Code'] == 'NoSuchEntity':
                          role_exists = False
                          print("Role does not exist")
                      else:
                          raise
                  
                  # Get or generate external ID
                  external_id = props.get('ExternalId', '')
                  if not external_id:
                      param_name = f'/spotsave/{role_name}/external-id'
                      try:
                          param = ssm.get_parameter(Name=param_name)
                          external_id = param['Parameter']['Value']
                          print(f"Got external ID from SSM")
                      except ClientError as e:
                          if e.response['Error']['Code'] == 'ParameterNotFound':
                              external_id = str(uuid.uuid4())
                              print(f"Generated new external ID")
                          else:
                              raise
                  
                  if event['RequestType'] == 'Delete':
                      send(event, context, SUCCESS, {})
                      return
                  
                  # Build assume role policy
                  policy = {
                      "Version": "2012-10-17",
                      "Statement": [{
                          "Effect": "Allow",
                          "Principal": {"AWS": f"arn:aws:iam::{account_id}:root"},
                          "Action": "sts:AssumeRole"
                      }]
                  }
                  if external_id:
                      policy["Statement"][0]["Condition"] = {
                          "StringEquals": {"sts:ExternalId": external_id}
                      }
                  
                  # Create or update role
                  if not role_exists:
                      role = iam.create_role(
                          RoleName=role_name,
                          AssumeRolePolicyDocument=json.dumps(policy)
                      )
                      role_arn = role['Role']['Arn']
                      print(f"Created role: {role_arn}")
                  else:
                      # role_arn already set from line 114
                      iam.update_assume_role_policy(
                          RoleName=role_name,
                          PolicyDocument=json.dumps(policy)
                      )
                      print(f"Updated role: {role_name} (ARN: {role_arn})")
                  
                  # Attach policies
                  for policy_arn in props.get('ManagedPolicyArns', []):
                      try:
                          iam.attach_role_policy(RoleName=role_name, PolicyArn=policy_arn)
                          print(f"Attached: {policy_arn}")
                      except ClientError as e:
                          if e.response['Error']['Code'] != 'EntityAlreadyExists':
                              print(f"Warning: {e}")
                  
                  # Inline policy
                  if props.get('InlinePolicyName') and props.get('InlinePolicyDocument'):
                      iam.put_role_policy(
                          RoleName=role_name,
                          PolicyName=props['InlinePolicyName'],
                          PolicyDocument=json.dumps(props['InlinePolicyDocument'])
                      )
                      print("Updated inline policy")
                  
                  # Store external ID
                  try:
                      ssm.put_parameter(
                          Name=f'/spotsave/{role_name}/external-id',
                          Value=external_id,
                          Type='String',
                          Overwrite=True
                      )
                  except:
                      pass
                  
                  send(event, context, SUCCESS, {
                      'RoleArn': role_arn,
                      'RoleName': role_name,
                      'ExternalId': external_id
                  })
                  
              except Exception as e:
                  print(f"ERROR: {str(e)}")
                  import traceback
                  print(traceback.format_exc())
                  try:
                      send(event, context, FAILED, {'Error': str(e)})
                  except:
                      raise

  # Custom resource that uses the Lambda to create/manage the role
  SpotSaveRole:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt RoleHandlerFunction.Arn
      RoleName: !Ref RoleName
      SpotSaveAccountId: !Ref SpotSaveAccountId
      ExternalId: !If 
        - HasExternalId
        - !Ref ExternalId
        - ''
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/job-function/Billing'
        - 'arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess'
        - 'arn:aws:iam::aws:policy/AWSPriceListServiceFullAccess'
        - 'arn:aws:iam::aws:policy/AmazonRDSReadOnlyAccess'
        - 'arn:aws:iam::aws:policy/AWSLambda_ReadOnlyAccess'
      InlinePolicyName: SpotSaveCloudWatchRead
      InlinePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'cloudwatch:GetMetricStatistics'
              - 'cloudwatch:ListMetrics'
              - 'cloudwatch:GetMetricData'
              - 'cloudwatch:DescribeAlarms'
            Resource: '*'
      Tags:
        - Key: ManagedBy
          Value: SpotSave
        - Key: Purpose
          Value: CostOptimizationScanning

Conditions:
  HasExternalId: !Not [!Equals [!Ref ExternalId, '']]

Outputs:
  RoleArn:
    Description: 'IAM Role ARN - Use this in SpotSave'
    Value: !GetAtt SpotSaveRole.RoleArn
    Export:
      Name: !Sub '${AWS::StackName}-RoleArn'
  
  ExternalId:
    Description: 'External ID - Use this in SpotSave (Keep secure!)'
    Value: !GetAtt SpotSaveRole.ExternalId
    Export:
      Name: !Sub '${AWS::StackName}-ExternalId'
  
  SetupInstructions:
    Description: 'Next steps'
    Value: !Sub |
      Setup Complete!
      
      1. Copy the Role ARN: ${SpotSaveRole.RoleArn}
      2. Copy the External ID: ${SpotSaveRole.ExternalId}
      3. Go to your SpotSave dashboard
      4. Enter these values to start scanning

